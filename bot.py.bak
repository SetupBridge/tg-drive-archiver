import os
import json
import logging
from datetime import datetime

from aiogram import Bot, Dispatcher, executor, types

from googleapiclient.discovery import build
from googleapiclient.http import MediaIoBaseUpload
from google_auth_oauthlib.flow import InstalledAppFlow
from google.oauth2.credentials import Credentials

# ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =================

BOT_TOKEN = "8509299729:AAGoKbxJcc6uxeBS6g1oxOe3_CgDEyQI4mI"

SCOPES = ["https://www.googleapis.com/auth/drive.file"]
CLIENT_SECRET_FILE = "client_secret.json"
TOKEN_FILE = "token.json"
FOLDER_FILE = "drive_folder.json"

logging.basicConfig(level=logging.INFO)

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

# ================= Google Auth =================

def get_creds():
    creds = None

    if os.path.exists(TOKEN_FILE):
        creds = Credentials.from_authorized_user_file(TOKEN_FILE, SCOPES)

    if not creds or not creds.valid:
        flow = InstalledAppFlow.from_client_secrets_file(
            CLIENT_SECRET_FILE,
            SCOPES
        )

        # â­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ùˆ Ø§Ù„Ø­Ù„
        creds = flow.run_console()

        with open(TOKEN_FILE, "w") as f:
            f.write(creds.to_json())

    return creds


def get_drive_service():
    creds = get_creds()
    return build("drive", "v3", credentials=creds)


# ================= Ø£Ø¯ÙˆØ§Øª =================

def clean_name(name):
    return "".join(c for c in name if c.isalnum() or c in " _-").strip()


def upload_text(creds, text, filename, folder_id):
    service = build("drive", "v3", credentials=creds)

    media = MediaIoBaseUpload(
        io := __import__("io").BytesIO(text.encode("utf-8")),
        mimetype="text/plain",
        resumable=False
    )

    file = service.files().create(
        body={
            "name": filename,
            "parents": [folder_id]
        },
        media_body=media,
        fields="id, webViewLink"
    ).execute()

    return file["webViewLink"]


# ================= Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª =================

@dp.message_handler(commands=["setup"])
async def setup_cmd(message: types.Message):
    await message.reply("â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Google Driveâ€¦ Ø´ÙˆÙ Ø§Ù„Ù€ Termux")

    get_drive_service()

    folder_name = f"TG Archive - {message.chat.title or message.chat.id}"
    service = get_drive_service()

    folder = service.files().create(
        body={
            "name": folder_name,
            "mimeType": "application/vnd.google-apps.folder"
        },
        fields="id"
    ).execute()

    with open(FOLDER_FILE, "w") as f:
        json.dump({"folder_id": folder["id"]}, f)

    await message.reply("âœ… ØªÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­")


@dp.message_handler(commands=["archive"])
async def archive_cmd(message: types.Message):
    if not os.path.exists(TOKEN_FILE):
        await message.reply("âŒ Ù„Ø§Ø²Ù… ØªØ³ÙˆÙŠ /setup Ø£ÙˆÙ„")
        return

    if not message.reply_to_message or not message.reply_to_message.text:
        await message.reply("âŒ Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© ÙÙ‚Ø·")
        return

    with open(FOLDER_FILE) as f:
        folder_id = json.load(f)["folder_id"]

    creds = Credentials.from_authorized_user_file(TOKEN_FILE, SCOPES)

    msg = message.reply_to_message
    content = (
        f"Chat: {message.chat.title}\n"
        f"From: {msg.from_user.full_name}\n"
        f"Date: {datetime.now()}\n"
        f"-----------------\n"
        f"{msg.text}"
    )

    filename = clean_name(f"{message.chat.title}-{msg.message_id}.txt")

    try:
        link = upload_text(creds, content, filename, folder_id)
        await message.reply(f"âœ… ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ©\nğŸ”— {link}")
    except Exception as e:
        await message.reply(f"âŒ Ø®Ø·Ø£: {e}")


# ================= ØªØ´ØºÙŠÙ„ =================

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
